<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hourly RFI Form</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 12px 40px rgba(17, 24, 39, 0.10);
      --primary: #111827;
      --primaryHover: #0b1220;
      --danger: #dc2626;
      --ring: rgba(17, 24, 39, 0.10);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1100px 420px at 50% -120px, #e5e7eb 0%, var(--bg) 55%, var(--bg) 100%);
      color: var(--text);
      padding: 28px 18px 44px;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(180deg, #111827 0%, #0b1220 100%);
      color: #fff;
      border-radius: var(--radius);
      padding: 22px 20px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.12);
      display: flex;
      gap: 14px;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .header .sub {
      margin-top: 6px;
      color: rgba(255,255,255,0.86);
      font-size: 13px;
    }

    .header .hint {
      margin-top: 12px;
      color: rgba(255,255,255,0.76);
      font-size: 13px;
      line-height: 1.35;
      max-width: 740px;
    }

    .lang-toggle {
      display: inline-flex;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      overflow: hidden;
      height: 40px;
      align-self: flex-start;
    }

    .lang-toggle button {
      height: 40px;
      padding: 0 12px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.85);
      font-weight: 900;
      letter-spacing: 0.02em;
      cursor: pointer;
    }

    .lang-toggle button.active {
      background: rgba(255,255,255,0.18);
      color: #fff;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      margin-top: 16px;
    }

    .card-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card h3 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    label {
      display: block;
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 800;
      margin: 0 0 8px;
    }

    input, select {
      width: 100%;
      height: 44px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }

    input:focus, select:focus {
      border-color: #c7cad1;
      box-shadow: 0 0 0 4px var(--ring);
    }

    input[readonly] {
      background: #f9fafb;
      font-weight: 800;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 780px) {
      .grid.two { grid-template-columns: 1fr 1fr; }
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    button {
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-weight: 900;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }

    button:hover { background: #f9fafb; }
    button:active { transform: translateY(1px); }

    .btn-primary {
      background: var(--primary);
      border-color: transparent;
      color: #fff;
      box-shadow: 0 10px 22px rgba(17,24,39,0.18);
    }

    .btn-primary:hover { background: var(--primaryHover); }

    .btn-danger {
      background: #fff;
      border-color: rgba(220,38,38,0.30);
      color: var(--danger);
    }

    .btn-danger:hover { background: rgba(220,38,38,0.06); }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.35;
      color: var(--muted);
      white-space: pre-wrap;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
    }

    thead th {
      background: #f9fafb;
      color: #374151;
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    tbody td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      text-align: center;
      font-weight: 650;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:nth-child(even) td { background: #fbfbfc; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1000;
    }

    .modal {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .modal-top {
      background: linear-gradient(180deg, #111827 0%, #0b1220 100%);
      color: #fff;
      padding: 16px 18px;
      font-weight: 900;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 14px;
    }

    .modal-body {
      padding: 16px 18px;
      color: var(--text);
    }

    .modal-body .title {
      font-weight: 950;
      font-size: 16px;
      margin: 0 0 10px;
    }

    .modal-body .question {
      margin: 0;
      color: var(--muted);
      font-weight: 750;
    }

    .modal-actions {
      padding: 14px 18px 18px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
      background: #fbfbfc;
    }

    .modal-actions button { min-width: 160px; }

    .modal-backdrop.show { display: flex; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="hdrTitle">Request for Information – Hourly Data</h1>
        <div class="sub" id="hdrSub">Hourly information request</div>
        <div class="hint" id="hdrHint">Enter manpower and hours worked for the day. Total hours calculate automatically. Submit when finished.</div>
      </div>
      <div class="lang-toggle" role="group" aria-label="Language">
        <button id="btnEnglish" type="button" class="active">EN</button>
        <button id="btnSpanish" type="button">ES</button>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3 id="secHourly">Hourly data</h3>
        <div class="muted" id="secHourlyHint">Total hours = manpower × hours per person.</div>
      </div>

      <div class="grid two">
        <div>
          <label for="projectName" id="lblProject">PROJECT NAME</label>
          <input type="text" id="projectName" placeholder="Enter project name" required />
        </div>

        <div>
          <label for="taskDescription" id="lblTask">TASK DESCRIPTION</label>
          <input type="text" id="taskDescription" placeholder="Enter task description" required />
        </div>

        <div>
          <label for="date" id="lblDate">DATE</label>
          <input type="date" id="date" />
        </div>

        <div>
          <label for="manpower" id="lblManpower">MANPOWER</label>
          <select id="manpower"></select>
        </div>

        <div>
          <label for="hoursPerPerson" id="lblHPP">HOURS PER PERSON</label>
          <select id="hoursPerPerson"></select>
        </div>

        <div>
          <label for="totalHours" id="lblTotal">TOTAL HOURS</label>
          <input type="text" id="totalHours" readonly />
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" id="btnEnter" type="button" onclick="addData()">ENTER DATA</button>
        <button type="button" id="btnAddMore" onclick="addMore()">ADD MORE</button>
        <button id="sendBtn" class="btn-primary" type="button" onclick="sendEmail()" disabled>SEND</button>
      </div>

      <div class="status" id="status"></div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3 id="secSubmitted">Data submitted</h3>
        <div class="muted" id="secSubmittedHint">Review entries before sending.</div>
      </div>

      <table id="dataTable">
        <thead>
          <tr>
            <th id="thDate">DATE</th>
            <th id="thManpower">MANPOWER</th>
            <th id="thHPP">HOURS PER PERSON</th>
            <th id="thTotal">TOTAL HOURS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="modal-backdrop" id="successModal" role="dialog" aria-modal="true" aria-labelledby="successTitle">
      <div class="modal">
        <div class="modal-top" id="modalTop">Submission</div>
        <div class="modal-body">
          <p class="title" id="successTitle">INFO SUBMITTED SUCCESSFULLY</p>
          <p class="question" id="successQuestion">WOULD YOU LIKE TO ADD ANOTHER PROJECT?</p>
        </div>
        <div class="modal-actions">
          <button id="modalYesBtn" class="btn-primary" type="button">YES</button>
          <button id="modalNoBtn" class="btn-danger" type="button">NO I'M DONE</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const EMAILJS_PUBLIC_KEY = 'Y23YPza-d8mge42dV';
    const EMAILJS_SERVICE_ID = 'service_ryus53s';
    const EMAILJS_TEMPLATE_ID = 'template_ezt4v6o';
    const TO_EMAIL = 'CHARLIE_VILLA@ICLOUD.COM';
    const DONE_URL = 'https://youtu.be/dQw4w9WgXcQ?si=yBKv4_o7GuQ4Js7r';

    const ui = {
      hdrTitle: document.getElementById('hdrTitle'),
      hdrSub: document.getElementById('hdrSub'),
      hdrHint: document.getElementById('hdrHint'),
      btnEnglish: document.getElementById('btnEnglish'),
      btnSpanish: document.getElementById('btnSpanish'),
      secHourly: document.getElementById('secHourly'),
      secHourlyHint: document.getElementById('secHourlyHint'),
      lblProject: document.getElementById('lblProject'),
      lblTask: document.getElementById('lblTask'),
      lblDate: document.getElementById('lblDate'),
      lblManpower: document.getElementById('lblManpower'),
      lblHPP: document.getElementById('lblHPP'),
      lblTotal: document.getElementById('lblTotal'),
      btnEnter: document.getElementById('btnEnter'),
      btnAddMore: document.getElementById('btnAddMore'),
      sendBtn: document.getElementById('sendBtn'),
      secSubmitted: document.getElementById('secSubmitted'),
      secSubmittedHint: document.getElementById('secSubmittedHint'),
      thDate: document.getElementById('thDate'),
      thManpower: document.getElementById('thManpower'),
      thHPP: document.getElementById('thHPP'),
      thTotal: document.getElementById('thTotal'),
      modalTop: document.getElementById('modalTop'),
      successTitle: document.getElementById('successTitle'),
      successQuestion: document.getElementById('successQuestion'),
      modalYesBtn: document.getElementById('modalYesBtn'),
      modalNoBtn: document.getElementById('modalNoBtn')
    };

    const strings = {
      en: {
        hdrTitle: 'Request for Information – Hourly Data',
        hdrSub: 'Hourly information request',
        hdrHint: 'Enter manpower and hours worked for the day. Total hours calculate automatically. Submit when finished.',
        secHourly: 'Hourly data',
        secHourlyHint: 'Total hours = manpower × hours per person.',
        lblProject: 'PROJECT NAME',
        lblTask: 'TASK DESCRIPTION',
        lblDate: 'DATE',
        lblManpower: 'MANPOWER',
        lblHPP: 'HOURS PER PERSON',
        lblTotal: 'TOTAL HOURS',
        btnEnter: 'ENTER DATA',
        btnAddMore: 'ADD MORE',
        send: 'SEND',
        secSubmitted: 'Data submitted',
        secSubmittedHint: 'Review entries before sending.',
        thDate: 'DATE',
        thManpower: 'MANPOWER',
        thHPP: 'HOURS PER PERSON',
        thTotal: 'TOTAL HOURS',
        modalTop: 'Submission',
        successTitle: 'INFO SUBMITTED SUCCESSFULLY',
        successQuestion: 'WOULD YOU LIKE TO ADD ANOTHER PROJECT?',
        yes: 'YES',
        no: "NO I'M DONE",
        alerts: {
          projectRequired: 'PROJECT NAME is required',
          taskRequired: 'TASK DESCRIPTION is required',
          completeAll: 'Please complete all fields',
          noData: 'No data to send',
          emailNotReady: 'Email service is not ready yet. Please wait a moment and try again.',
          emailLibMissing: 'EmailJS library did not load.',
          emailFailed: 'Email failed to send.'
        }
      },
      es: {
        hdrTitle: 'Solicitud de información – Horas',
        hdrSub: 'Solicitud de información por hora',
        hdrHint: 'Ingrese la mano de obra y las horas trabajadas del día. Las horas totales se calculan automáticamente. Envíe cuando termine.',
        secHourly: 'Datos por hora',
        secHourlyHint: 'Horas totales = mano de obra × horas por persona.',
        lblProject: 'NOMBRE DEL PROYECTO',
        lblTask: 'DESCRIPCIÓN DE LA TAREA',
        lblDate: 'FECHA',
        lblManpower: 'MANO DE OBRA',
        lblHPP: 'HORAS POR PERSONA',
        lblTotal: 'HORAS TOTALES',
        btnEnter: 'AGREGAR',
        btnAddMore: 'AGREGAR MÁS',
        send: 'ENVIAR',
        secSubmitted: 'Datos enviados',
        secSubmittedHint: 'Revise las entradas antes de enviar.',
        thDate: 'FECHA',
        thManpower: 'MANO DE OBRA',
        thHPP: 'HORAS POR PERSONA',
        thTotal: 'HORAS TOTALES',
        modalTop: 'Envío',
        successTitle: 'INFORMACIÓN ENVIADA CON ÉXITO',
        successQuestion: '¿DESEA AGREGAR OTRO PROYECTO?',
        yes: 'SÍ',
        no: 'NO, YA TERMINÉ',
        alerts: {
          projectRequired: 'El NOMBRE DEL PROYECTO es obligatorio',
          taskRequired: 'La DESCRIPCIÓN DE LA TAREA es obligatoria',
          completeAll: 'Por favor complete todos los campos',
          noData: 'No hay datos para enviar',
          emailNotReady: 'El servicio de correo no está listo.',
          emailLibMissing: 'No se cargó la librería de EmailJS.',
          emailFailed: 'No se pudo enviar el correo.'
        }
      }
    };

    let currentLang = 'en';

    function setLanguage(lang) {
      const fallback = strings.en;
      const s = strings[lang] || fallback;
      currentLang = strings[lang] ? lang : 'en';

      ui.hdrTitle.textContent = s.hdrTitle;
      ui.hdrSub.textContent = s.hdrSub;
      ui.hdrHint.textContent = s.hdrHint;

      ui.secHourly.textContent = s.secHourly;
      ui.secHourlyHint.textContent = s.secHourlyHint;

      ui.lblProject.textContent = s.lblProject;
      ui.lblTask.textContent = s.lblTask;
      ui.lblDate.textContent = s.lblDate;
      ui.lblManpower.textContent = s.lblManpower;
      ui.lblHPP.textContent = s.lblHPP;
      ui.lblTotal.textContent = s.lblTotal;

      ui.btnEnter.textContent = s.btnEnter;
      ui.btnAddMore.textContent = s.btnAddMore;
      ui.sendBtn.textContent = s.send;

      ui.secSubmitted.textContent = s.secSubmitted;
      ui.secSubmittedHint.textContent = s.secSubmittedHint;

      ui.thDate.textContent = s.thDate;
      ui.thManpower.textContent = s.thManpower;
      ui.thHPP.textContent = s.thHPP;
      ui.thTotal.textContent = s.thTotal;

      ui.modalTop.textContent = s.modalTop;
      ui.successTitle.textContent = s.successTitle;
      ui.successQuestion.textContent = s.successQuestion;
      ui.modalYesBtn.textContent = s.yes;
      ui.modalNoBtn.textContent = s.no;

      ui.btnEnglish.classList.toggle('active', currentLang === 'en');
      ui.btnSpanish.classList.toggle('active', currentLang === 'es');
    }

    ui.btnEnglish.addEventListener('click', () => setLanguage('en'));
    ui.btnSpanish.addEventListener('click', () => setLanguage('es'));

    function tAlert(key) {
      const s = strings[currentLang] || strings.en;
      return (s.alerts && s.alerts[key]) ? s.alerts[key] : ((strings.en.alerts && strings.en.alerts[key]) ? strings.en.alerts[key] : '');
    }

    const projectNameInput = document.getElementById('projectName');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const manpowerSelect = document.getElementById('manpower');
    const hoursPerPersonSelect = document.getElementById('hoursPerPerson');
    const totalHoursInput = document.getElementById('totalHours');
    const statusEl = document.getElementById('status');

    const successModal = document.getElementById('successModal');

    let emailJsLibLoaded = false;
    let emailJsReady = false;

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? '#dc2626' : '#065f46';
    }

    function addOption(selectEl, value) {
      const opt = document.createElement('option');
      opt.value = String(value);
      opt.textContent = String(value);
      selectEl.appendChild(opt);
    }

    for (let i = 1; i <= 15; i++) {
      addOption(manpowerSelect, i);
      addOption(hoursPerPersonSelect, i);
    }

    function computeAndDisplayTotalHours() {
      const mp = Number(manpowerSelect.value || 0);
      const hpp = Number(hoursPerPersonSelect.value || 0);
      const total = mp * hpp;
      totalHoursInput.value = total > 0 ? String(total) : '';
      return total;
    }

    manpowerSelect.addEventListener('change', computeAndDisplayTotalHours);
    hoursPerPersonSelect.addEventListener('change', computeAndDisplayTotalHours);

    function showSuccessModal() {
      successModal.classList.add('show');
    }

    function hideSuccessModal() {
      successModal.classList.remove('show');
    }

    ui.modalYesBtn.addEventListener('click', () => {
      hideSuccessModal();
      window.location.reload();
    });

    ui.modalNoBtn.addEventListener('click', () => {
      hideSuccessModal();
      try {
        if (window.top && window.top !== window) {
          window.top.location.href = DONE_URL;
        } else {
          window.location.assign(DONE_URL);
        }
      } catch (e) {
        window.location.assign(DONE_URL);
      }
    });

    successModal.addEventListener('click', (e) => {
      if (e.target === successModal) hideSuccessModal();
    });

    function validateProjectFields() {
      const projectName = (projectNameInput.value || '').trim();
      const taskDescription = (taskDescriptionInput.value || '').trim();

      if (!projectName) {
        alert(tAlert('projectRequired'));
        projectNameInput.focus();
        return null;
      }

      if (!taskDescription) {
        alert(tAlert('taskRequired'));
        taskDescriptionInput.focus();
        return null;
      }

      return { projectName, taskDescription };
    }

    function formatDateMDY(isoDate) {
      if (!isoDate) return '';
      const parts = isoDate.split('-');
      if (parts.length !== 3) return isoDate;
      const year = parts[0];
      const month = parts[1];
      const day = parts[2];
      return `${month}-${day}-${year}`;
    }

    function formatHoursLabel(value) {
      const n = Number(value);
      if (!Number.isFinite(n)) return String(value);
      return n === 1 ? `${n} HOUR` : `${n} HOURS`;
    }

    function addData() {
      const ok = validateProjectFields();
      if (!ok) return;

      const date = document.getElementById('date').value;
      const manpower = manpowerSelect.value;
      const hoursPerPerson = hoursPerPersonSelect.value;
      const totalHours = computeAndDisplayTotalHours();

      if (!date || !hoursPerPerson) {
        alert(tAlert('completeAll'));
        return;
      }

      const table = document.querySelector('#dataTable tbody');
      const row = table.insertRow();
      row.insertCell(0).textContent = formatDateMDY(date);
      row.insertCell(1).textContent = formatHoursLabel(manpower);
      row.insertCell(2).textContent = formatHoursLabel(hoursPerPerson);
      row.insertCell(3).textContent = formatHoursLabel(totalHours);
      setStatus('');
    }

    function clearEntryFields() {
      document.getElementById('date').value = '';
      manpowerSelect.selectedIndex = 0;
      hoursPerPersonSelect.selectedIndex = 0;
      totalHoursInput.value = '';
    }

    function resetFields() {
      projectNameInput.value = '';
      taskDescriptionInput.value = '';
      clearEntryFields();
      setStatus('');
    }

    function addMore() {
      addData();
      clearEntryFields();
    }

    function buildTableData() {
      const rows = document.querySelectorAll('#dataTable tbody tr');
      if (rows.length === 0) return '';

      let tableData = 'DATE | MANPOWER | HOURS PER PERSON | TOTAL HOURS\n';
      tableData += '-----------------------------------------------\n';

      rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        tableData += `${cols[0].innerText} | ${cols[1].innerText} | ${cols[2].innerText} | ${cols[3].innerText}\n`;
      });

      return tableData;
    }

    function buildEmailMessage(projectName, taskDescription) {
      const tableData = buildTableData();
      if (!tableData) return '';
      return `PROJECT NAME: ${projectName}\nTASK DESCRIPTION: ${taskDescription}\n\n${tableData}`;
    }

    function loadEmailJsLibrary() {
      const existing = document.querySelector('script[data-emailjs="1"]');
      if (existing) return;

      const script = document.createElement('script');
      script.dataset.emailjs = '1';
      script.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
      script.async = true;

      script.onload = function () {
        emailJsLibLoaded = true;
        tryInitEmailJs();
      };

      script.onerror = function () {
        emailJsLibLoaded = false;
        emailJsReady = false;
        ui.sendBtn.disabled = true;
        setStatus('Failed to load EmailJS library (network error).', true);
      };

      document.head.appendChild(script);
    }

    function tryInitEmailJs() {
      emailJsReady = false;
      ui.sendBtn.disabled = true;

      if (!emailJsLibLoaded) {
        setStatus('Loading email service…');
        return;
      }

      try {
        if (typeof emailjs === 'undefined' || !emailjs || typeof emailjs.init !== 'function') {
          setStatus('EmailJS library did not initialize correctly. Try reloading the page.', true);
          return;
        }
        emailjs.init(EMAILJS_PUBLIC_KEY);
        emailJsReady = true;
        ui.sendBtn.disabled = false;
        setStatus('Email service ready ✅');
      } catch (e) {
        emailJsReady = false;
        ui.sendBtn.disabled = true;
        setStatus('Email service failed to initialize.', true);
      }
    }

    function sendEmail() {
      if (!emailJsReady) {
        alert(tAlert('emailNotReady'));
        return;
      }

      if (typeof emailjs === 'undefined') {
        setStatus('EmailJS library is not available. Check your network connection.', true);
        alert(tAlert('emailLibMissing'));
        return;
      }

      const ok = validateProjectFields();
      if (!ok) return;

      const message = buildEmailMessage(ok.projectName, ok.taskDescription);
      if (!message) {
        alert(tAlert('noData'));
        return;
      }

      const templateParams = {
        to_email: TO_EMAIL,
        to: TO_EMAIL,
        message: message,
        message_text: message,
        subject: 'Hourly RFI Submission'
      };

      setStatus('Sending email…');
      ui.sendBtn.disabled = true;

      emailjs
        .send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
        .then(() => {
          setStatus('Email sent successfully');
          document.querySelector('#dataTable tbody').innerHTML = '';
          resetFields();
          showSuccessModal();
        })
        .catch(error => {
          const detail = (error && (error.text || error.message)) ? (error.text || error.message) : JSON.stringify(error);
          setStatus(
            'Email failed to send. Most common causes: (1) wrong Service ID/Template ID, (2) template missing variables (to_email/message), or (3) this domain not allowed in EmailJS. Error detail: ' + detail,
            true
          );
          alert(tAlert('emailFailed'));
        })
        .finally(() => {
          ui.sendBtn.disabled = !emailJsReady;
        });
    }

    function runTests() {
      try {
        console.assert(typeof setLanguage === 'function', 'setLanguage should be defined');
        console.assert(typeof addMore === 'function', 'addMore should be defined');
        console.assert(typeof tAlert === 'function', 'tAlert should be defined');
        console.assert(manpowerSelect.options.length === 15, 'Manpower dropdown should have 15 options');
        console.assert(hoursPerPersonSelect.options.length === 15, 'Hours Per Person dropdown should have 15 options');

        setLanguage('en');
        console.assert(ui.lblProject.textContent === 'PROJECT NAME', 'EN labels should be English');
        setLanguage('es');
        console.assert(ui.lblProject.textContent === 'NOMBRE DEL PROYECTO', 'ES labels should be Spanish');
        setLanguage('en');

        manpowerSelect.value = '3';
        hoursPerPersonSelect.value = '4';
        const t = computeAndDisplayTotalHours();
        console.assert(t === 12, 'Total hours should equal manpower * hours per person');

        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        const tr = tbody.insertRow();
        tr.insertCell(0).textContent = '12-24-2025';
        tr.insertCell(1).textContent = '2 HOURS';
        tr.insertCell(2).textContent = '3 HOURS';
        tr.insertCell(3).textContent = '6 HOURS';
        const msg = buildEmailMessage('Karma Barn', 'Door install');
        console.assert(msg.includes('PROJECT NAME: Karma Barn'), 'Email message should include project name');
        console.assert(msg.includes('TASK DESCRIPTION: Door install'), 'Email message should include task description');
        tbody.innerHTML = '';

        const emptyMsg = buildEmailMessage('Karma Barn', 'Door install');
        console.assert(emptyMsg === '', 'Email message should be empty when no rows exist');
      } catch (e) {
        console.warn('Tests skipped:', e);
      } finally {
        resetFields();
      }
    }

    setLanguage('en');
    computeAndDisplayTotalHours();
    resetFields();
    loadEmailJsLibrary();
    runTests();
  </script>
</body>
</html>
